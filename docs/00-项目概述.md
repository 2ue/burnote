# Enclosed 改造方案 - 项目概述

## 【Linus的警告】

> "你正在做的事情,就像在F1赛车上装个货箱。能装东西了,但失去了速度。"
>
> **Enclosed的核心价值是零知识加密**。添加管理功能会让服务器知道"谁创建了什么",隐私保证降低。
>
> 如果你真的需要管理功能,我建议你直接用 **Snippet Box** 或 **QBin**。

但既然你坚持,我会给你一个**最小破坏性**的方案。

---

## 一、改造目标

### 核心需求

为 Enclosed 添加以下功能:

1. **我的分享列表页面** - 查看自己创建的所有notes
2. **删除功能** - 可以删除自己的notes
3. **标��/备注** - 为note添加标题(客户端加密)
4. **创建时间** - 显示note创建时间

### 不改变的部分

- ✅ 端到端加密机制(内容仍然服务器不可见)
- ✅ 密码保护
- ✅ 过期时间
- ✅ 阅后即焚
- ✅ 匿名分享(可选)

---

## 二、架构设计

### 2.1 数据流设计

```
┌─────────────┐
│  用户浏览器  │
└──────┬──────┘
       │
       │ 1. 创建note
       │    - 生成加密密钥(客户端)
       │    - 加密内容(客户端)
       │    - 加密标题(客户端,可选)
       │
       ▼
┌──────────────────┐
│  Enclosed Server │
│                  │
│  存储:           │
│  - noteId        │
│  - payload(加密) │ ◄── 服务器看不到内容
│  - encTitle(加密)│ ◄── 服务器看不到标题
│  - createdBy     │ ◄── 新增:用户ID(可选)
│  - createdAt     │ ◄── 新增:创建时间
│  - metadata      │
└──────────────────┘
       │
       │ 2. 返回noteId
       │
       ▼
┌─────────────┐
│  用户浏览器  │
│             │
│  存储到      │
│  localStorage:│
│  - noteId    │
│  - url(含key)│
│  - title(明文)│ ◄── 本地存储,用于快速查看
│  - createdAt │
└─────────────┘
```

### 2.2 关键设计原则

1. **双层存储策略**
   - **服务器**: 存储加密数据 + metadata + 用户关联
   - **LocalStorage**: 存储明文标题 + URL(用于列表展示)

2. **用户关联的可选性**
   - 如果用户登录: `createdBy` 字段记录userId
   - 如果匿名分享: `createdBy` 为 `null`

3. **删除策略**
   - 用户可删除自己创建的notes
   - 但如果localStorage被清空,历史记录丢失(这是trade-off)

---

## 三、核心改动点

### 3.1 后端改动

**文件**: `packages/app-server/src/modules/notes/`

1. **notes.types.ts** - 扩展类型定义
2. **notes.repository.ts** - 添加按用户查询和删除方法
3. **notes.routes.ts** - 新增管理API
4. **notes.models.ts** - 添加元数据格式化逻辑

**预估代码量**: ~200行

### 3.2 前端改动

**文件**: `packages/app-client/src/modules/`

1. **routes.tsx** - 添加 `/my-notes` 路由
2. **notes/pages/my-notes.page.tsx** - 新建管理页面
3. **notes/notes.services.ts** - 添加localStorage管理逻辑
4. **notes/pages/create-note.page.tsx** - 保存到localStorage

**预估代码量**: ~300行

---

## 四、实现策略

### 阶段1: 最小可用版本(MVP)

**目标**: 实现基础的列表+删除功能

**功能**:
- [x] localStorage存储note列表
- [x] "我的分享"页面,展示列表
- [x] 点击跳转到详情页
- [x] 删除按钮(删除localStorage记录 + 调用API)

**时间**: 1-2天

### 阶段2: 服务器关联

**目标**: 将notes关联到用户账户

**功能**:
- [x] 数据库添加 `createdBy` 字段
- [x] API返回用户的notes列表
- [x] 删除时验证权限

**时间**: 1天

### 阶段3: 高级功能

**目标**: 添加标题、搜索等

**功能**:
- [x] 加密标题存储
- [x] 搜索过滤
- [x] 批量删除

**时间**: 2-3天

---

## 五、技术栈

### 不变部分

- **后端**: HonoJS + Unstorage + Zod
- **前端**: SolidJS + UnoCSS
- **存储**: 文件系统/Cloudflare KV

### 新增依赖

可能需要:
- `date-fns` (已有) - 日期格式化
- 无需新增其他依赖

---

## 六、风险评估

### 隐私风险

| 风险 | 级别 | 说明 | 缓解措施 |
|------|------|------|----------|
| 服务器知道用户创建了哪些note | ⚠️ 中 | 原本完全匿名,现在有关联 | 提供"匿名创建"选项 |
| LocalStorage丢失��致历史丢失 | ⚠️ 中 | 清除浏览器数据=丢失列表 | 提醒用户导出列表 |
| 服务器管理员可删除用户notes | ⚠️ 低 | 原本也可以通过ID删除 | 无额外风险 |

### 技术风险

| 风险 | 级别 | 说明 | 缓解措施 |
|------|------|------|----------|
| Unstorage不支持查询 | 🔴 高 | KV存储无法高效查询 | 使用内存索引/切换SQLite |
| LocalStorage容量限制 | ⚠️ 中 | 大量notes可能超限 | 分页/定期清理 |
| 多设备同步问题 | ⚠️ 低 | localStorage不跨设备 | 文档说明限制 |

---

## 七、与原版Enclosed的兼容性

### 保持兼容

- ✅ 原有的API(`POST /api/notes`, `GET /api/notes/:id`)不变
- ✅ 加密逻辑不变
- ✅ CLI工具继续可用
- ✅ 无用户登录时,功能与原版一致

### 不兼容点

- ⚠️ 数据库schema变更(需要迁移)
- ⚠️ 环境变量新增(需要更新配置)

---

## 八、下一步

阅读详细设计文档:

1. **[01-需求分析.md](./01-需求分析.md)** - 了解详细功能规划
2. **[02-数据结构设计.md](./02-数据结构设计.md)** - 了解数据模型
3. **[05-实现步骤.md](./05-实现步骤.md)** - 开始编码

---

**Linus的最后建议**:

> "如果读到这里你还没改变主意,那就动手吧。但记住:
>
> **简单比复杂好,清晰比聪明好,有用比完美好。**
>
> 先实现最基础的功能,能用了再优化。不要一开始就追求完美,那会让你陷入复杂性的泥潭。"
