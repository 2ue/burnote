# Enclosed 改造方案 - 实现步骤

## 【Linus的实现哲学】

> "一次做一件事,做好它。然后再做下一件。"
>
> **不要试图一次实现所有功能**。先让最基础的能跑起来,再逐步添加。
>
> **能用 > 完美 > 复杂**

---

## 阶段划分

### 阶段1: LocalStorage基础 (1-2天)
**目标**: 实现纯客户端的notes管理,不改后端

### 阶段2: 服务器关联 (1天)
**目标**: 将notes关联到用户账户

### 阶段3: 高级功能 (2-3天)
**目标**: 添加搜索、标题加密等

---

## 阶段1: LocalStorage基础实现

### Step 1.1: 创建LocalStorage管理模块

**文件**: `packages/app-client/src/modules/notes/notes.storage.ts`

```typescript
// ========================================
// LocalStorage管理模块
// ========================================

const STORAGE_KEY = 'enclosed_my_notes';
const STORAGE_VERSION = '1.0.0';

export interface LocalNoteRecord {
  noteId: string;
  url: string;
  title?: string;
  createdAt: string;
  expiresAt?: string;
  deleteAfterReading: boolean;
  isPasswordProtected: boolean;
}

interface LocalStorageData {
  version: string;
  notes: LocalNoteRecord[];
}

// 初始化localStorage
function initStorage(): LocalStorageData {
  return {
    version: STORAGE_VERSION,
    notes: []
  };
}

// 读取所有notes
export function loadNotes(): LocalNoteRecord[] {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const data: LocalStorageData = JSON.parse(raw);

    // 版本迁移(如果需要)
    if (!data.version) {
      const migrated = {
        version: STORAGE_VERSION,
        notes: Array.isArray(data) ? data : []
      };
      saveNotes(migrated.notes);
      return migrated.notes;
    }

    return data.notes || [];
  } catch (error) {
    console.error('Failed to load notes from localStorage:', error);
    return [];
  }
}

// 保存notes
export function saveNotes(notes: LocalNoteRecord[]): void {
  try {
    const data: LocalStorageData = {
      version: STORAGE_VERSION,
      notes
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (error) {
    console.error('Failed to save notes to localStorage:', error);
  }
}

// 添加新note
export function addNote(note: LocalNoteRecord): void {
  const notes = loadNotes();
  notes.unshift(note); // 最新的在前面
  saveNotes(notes);
}

// 删除note
export function removeNote(noteId: string): void {
  const notes = loadNotes();
  const filtered = notes.filter(n => n.noteId !== noteId);
  saveNotes(filtered);
}

// 更新note
export function updateNote(noteId: string, updates: Partial<LocalNoteRecord>): void {
  const notes = loadNotes();
  const index = notes.findIndex(n => n.noteId === noteId);
  if (index !== -1) {
    notes[index] = { ...notes[index], ...updates };
    saveNotes(notes);
  }
}

// 计算note状态
export function calculateNoteStatus(note: LocalNoteRecord): 'active' | 'expired' | 'destroyed' {
  if (note.deleteAfterReading) {
    // 阅后即焚的note无法判断是否被查看,标记为potentially destroyed
    return 'destroyed';
  }

  if (note.expiresAt) {
    const now = new Date();
    const expiresAt = new Date(note.expiresAt);
    if (now > expiresAt) {
      return 'expired';
    }
  }

  return 'active';
}
```

**测试**:
```typescript
// 在浏览器console测试
import { addNote, loadNotes } from './notes.storage';

addNote({
  noteId: 'test123',
  url: 'http://localhost:8787/test123#key=abc',
  title: 'Test Note',
  createdAt: new Date().toISOString(),
  deleteAfterReading: false,
  isPasswordProtected: false
});

console.log(loadNotes()); // 应该看到新增的note
```

---

### Step 1.2: 修改创建页面,保存到LocalStorage

**文件**: `packages/app-client/src/modules/notes/pages/create-note.page.tsx`

**找到创建成功的代码**(大约174-179行):

```typescript
// 原代码
if (!error) {
  const { noteUrl } = createdNote;
  setNoteUrl(noteUrl);
  setIsNoteCreated(true);
  return;
}
```

**修改为**:

```typescript
import { addNote } from '../notes.storage'; // 新增import
import { parseNoteUrl } from '@enclosed/lib';

// ...

if (!error) {
  const { noteUrl } = createdNote;
  setNoteUrl(noteUrl);
  setIsNoteCreated(true);

  // === 新增代码: 保存到localStorage ===
  try {
    const { noteId } = parseNoteUrl({ noteUrl });

    addNote({
      noteId,
      url: noteUrl,
      title: getTitle(), // 需要添加title输入框
      createdAt: new Date().toISOString(),
      expiresAt: getHasNoExpiration()
        ? undefined
        : new Date(Date.now() + getTtlInSeconds() * 1000).toISOString(),
      deleteAfterReading: getDeleteAfterReading(),
      isPasswordProtected: !!getPassword()
    });
  } catch (err) {
    console.error('Failed to save note to localStorage:', err);
  }
  // === 新增代码结束 ===

  return;
}
```

**添加标题输入框**(在密码输入框之前,约248行):

```typescript
// 在密码输入框上方添加
<TextFieldRoot class="w-full">
  <TextFieldLabel>
    {t('create.settings.title.label')} {/* 需要添加翻译 */}
  </TextFieldLabel>
  <TextField
    placeholder={t('create.settings.title.placeholder')}
    value={getTitle()}
    onInput={e => setTitle(e.currentTarget.value)}
    data-test-id="note-title"
  />
</TextFieldRoot>
```

**添加state** (在组件开头):

```typescript
const [getTitle, setTitle] = createSignal('');

// 在resetNoteForm()中添加
setTitle('');
```

---

### Step 1.3: 创建"我的分享"列表页面

**文件**: `packages/app-client/src/modules/notes/pages/my-notes.page.tsx` (新建)

```typescript
import { useI18n } from '@/modules/i18n/i18n.provider';
import { Button } from '@/modules/ui/components/button';
import { Card, CardContent, CardHeader } from '@/modules/ui/components/card';
import { A } from '@solidjs/router';
import { Component, createSignal, For, onMount, Show } from 'solid-js';
import { calculateNoteStatus, loadNotes, LocalNoteRecord, removeNote } from '../notes.storage';
import { CopyButton } from '@/modules/shared/utils/copy';
import { toast } from '@/modules/ui/components/sonner';

const StatusBadge: Component<{ status: 'active' | 'expired' | 'destroyed' }> = (props) => {
  const { t } = useI18n();

  const getConfig = () => {
    switch (props.status) {
      case 'active':
        return { icon: 'i-tabler-check', color: 'text-green-600', label: t('my-notes.status.active') };
      case 'expired':
        return { icon: 'i-tabler-clock-x', color: 'text-orange-600', label: t('my-notes.status.expired') };
      case 'destroyed':
        return { icon: 'i-tabler-flame', color: 'text-red-600', label: t('my-notes.status.destroyed') };
    }
  };

  const config = getConfig();

  return (
    <span class={`flex items-center gap-1 text-sm ${config.color}`}>
      <div class={config.icon}></div>
      {config.label}
    </span>
  );
};

const NoteItem: Component<{
  note: LocalNoteRecord;
  onDelete: (noteId: string) => void;
}> = (props) => {
  const { t } = useI18n();
  const [getIsDeleting, setIsDeleting] = createSignal(false);

  const status = () => calculateNoteStatus(props.note);

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();

    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 60) return t('my-notes.time.minutes-ago', { count: minutes });
    if (hours < 24) return t('my-notes.time.hours-ago', { count: hours });
    return t('my-notes.time.days-ago', { count: days });
  };

  const handleDelete = async () => {
    if (!confirm(t('my-notes.delete-confirm'))) return;

    setIsDeleting(true);

    try {
      // TODO: 调用API删除服务器端数据
      // await fetch(`/api/notes/${props.note.noteId}`, { method: 'DELETE' });

      props.onDelete(props.note.noteId);
      toast.success(t('my-notes.delete-success'));
    } catch (error) {
      console.error('Failed to delete note:', error);
      toast.error(t('my-notes.delete-error'));
      setIsDeleting(false);
    }
  };

  return (
    <Card>
      <CardContent class="p-4">
        <div class="flex items-start gap-4">
          {/* 图标 */}
          <div class="text-3xl text-muted-foreground op-50 flex-shrink-0">
            <Show when={props.note.isPasswordProtected} fallback={<div class="i-tabler-file-text"></div>}>
              <div class="i-tabler-lock"></div>
            </Show>
          </div>

          {/* 内容 */}
          <div class="flex-1 min-w-0">
            <h3 class="font-semibold truncate">
              {props.note.title || t('my-notes.untitled')}
            </h3>

            <div class="flex items-center gap-3 mt-1 text-sm text-muted-foreground">
              <span>{formatDate(props.note.createdAt)}</span>
              <span>•</span>
              <StatusBadge status={status()} />
              <Show when={props.note.expiresAt}>
                <span>•</span>
                <span>{t('my-notes.expires')}: {formatDate(props.note.expiresAt!)}</span>
              </Show>
            </div>
          </div>

          {/* 操作按钮 */}
          <div class="flex items-center gap-2 flex-shrink-0">
            <CopyButton
              variant="ghost"
              size="sm"
              text={props.note.url}
              label=""
              copiedLabel=""
              class="size-9"
            >
              <div class="i-tabler-copy"></div>
            </CopyButton>

            <Button
              as={A}
              href={props.note.url}
              variant="ghost"
              size="sm"
              class="size-9"
              disabled={status() !== 'active'}
            >
              <div class="i-tabler-eye"></div>
            </Button>

            <Button
              variant="ghost"
              size="sm"
              class="size-9"
              onClick={handleDelete}
              disabled={getIsDeleting()}
            >
              <div class={getIsDeleting() ? 'i-tabler-loader-2 animate-spin' : 'i-tabler-trash'}></div>
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export const MyNotesPage: Component = () => {
  const { t } = useI18n();
  const [getNotes, setNotes] = createSignal<LocalNoteRecord[]>([]);
  const [getFilter, setFilter] = createSignal<'all' | 'active' | 'expired'>('all');

  onMount(() => {
    loadNotesFromStorage();
  });

  const loadNotesFromStorage = () => {
    const notes = loadNotes();
    setNotes(notes);
  };

  const handleDelete = (noteId: string) => {
    removeNote(noteId);
    loadNotesFromStorage();
  };

  const filteredNotes = () => {
    const notes = getNotes();
    const filter = getFilter();

    if (filter === 'all') return notes;

    return notes.filter(note => {
      const status = calculateNoteStatus(note);
      return filter === 'active' ? status === 'active' : status === 'expired';
    });
  };

  return (
    <div class="mx-auto max-w-1200px px-6 mt-6">
      {/* 标题 */}
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">{t('my-notes.title')}</h1>
          <p class="text-muted-foreground">{t('my-notes.description')}</p>
        </div>
        <Button as={A} href="/">
          <div class="i-tabler-plus mr-2"></div>
          {t('my-notes.create-new')}
        </Button>
      </div>

      {/* 过滤器 */}
      <div class="flex gap-2 mb-4">
        <Button
          variant={getFilter() === 'all' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilter('all')}
        >
          {t('my-notes.filter.all')} ({getNotes().length})
        </Button>
        <Button
          variant={getFilter() === 'active' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilter('active')}
        >
          {t('my-notes.filter.active')} ({getNotes().filter(n => calculateNoteStatus(n) === 'active').length})
        </Button>
        <Button
          variant={getFilter() === 'expired' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilter('expired')}
        >
          {t('my-notes.filter.expired')} ({getNotes().filter(n => calculateNoteStatus(n) === 'expired').length})
        </Button>
      </div>

      {/* 列表 */}
      <Show when={filteredNotes().length > 0} fallback={
        <Card class="mt-6">
          <CardContent class="p-12 text-center">
            <div class="i-tabler-inbox text-5xl text-muted-foreground op-50 mx-auto mb-4"></div>
            <h3 class="font-semibold text-lg mb-2">{t('my-notes.empty.title')}</h3>
            <p class="text-muted-foreground">{t('my-notes.empty.description')}</p>
            <Button as={A} href="/" class="mt-4">
              {t('my-notes.empty.create-first')}
            </Button>
          </CardContent>
        </Card>
      }>
        <div class="flex flex-col gap-3">
          <For each={filteredNotes()}>
            {note => <NoteItem note={note} onDelete={handleDelete} />}
          </For>
        </div>
      </Show>
    </div>
  );
};
```

---

### Step 1.4: 添加路由

**文件**: `packages/app-client/src/routes.tsx`

```typescript
import { MyNotesPage } from './modules/notes/pages/my-notes.page'; // 新增

// 在 routes 数组中添加
{
  path: '/my-notes',
  component: MyNotesPage,
},
```

---

### Step 1.5: 添加导航链接

**文件**: `packages/app-client/src/modules/ui/layouts/app.layout.tsx`

在header中添加导航链接(具体位置需要看原代码结构):

```typescript
<Button as={A} href="/my-notes" variant="ghost">
  <div class="i-tabler-list mr-2"></div>
  {t('nav.my-notes')}
</Button>
```

---

### Step 1.6: 添加翻译

**文件**: `packages/app-client/src/modules/i18n/locales/en.json`

```json
{
  "my-notes": {
    "title": "My Shares",
    "description": "Manage your shared notes",
    "create-new": "Create New",
    "untitled": "Untitled Note",
    "expires": "Expires",
    "status": {
      "active": "Active",
      "expired": "Expired",
      "destroyed": "Destroyed"
    },
    "filter": {
      "all": "All",
      "active": "Active",
      "expired": "Expired"
    },
    "time": {
      "minutes-ago": "{{count}} minutes ago",
      "hours-ago": "{{count}} hours ago",
      "days-ago": "{{count}} days ago"
    },
    "delete-confirm": "Are you sure you want to delete this note?",
    "delete-success": "Note deleted successfully",
    "delete-error": "Failed to delete note",
    "empty": {
      "title": "No notes yet",
      "description": "Create your first note to get started",
      "create-first": "Create First Note"
    }
  },
  "create": {
    "settings": {
      "title": {
        "label": "Title (optional)",
        "placeholder": "e.g., API Key, Meeting Notes..."
      }
    }
  }
}
```

---

## 阶段1 测试清单

完成阶段1后,测试以下功能:

- [ ] 创建note时,输入标题
- [ ] 创建成功后,localStorage中有新记录
- [ ] 访问 `/my-notes` 能看到列表
- [ ] 列表显示标题、时间、状态
- [ ] 点击"复制"按钮能复制链接
- [ ] 点击"查看"按钮能跳转到详情页
- [ ] 点击"删除"按钮能删除记录(仅localStorage)
- [ ] 过滤器能正确筛选active/expired notes
- [ ] 刷新页面后,列表仍然存在

---

## 阶段2: 服务器关联 (下一步)

**目标**: 将notes关联到用户账户,实现跨设备同步

**主要工作**:
1. 修改后端schema
2. 添加 `GET /api/users/me/notes` API
3. 添加 `DELETE /api/notes/:noteId` API
4. 前端调用新API

详细步骤见下一节...

---

**继续阅读**: 创建其他文档或开始编码实现
